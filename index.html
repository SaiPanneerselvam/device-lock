<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Device Lock Control</title>
  <style>
    body { background:#000; color:#0ff; font-family: Arial, sans-serif; text-align:center; padding-top:60px; }
    button { font-size:18px; padding:12px 20px; margin:12px; cursor:pointer; border:none; border-radius:6px; }
    .lock { background:#c44; color:white; }
    .unlock { background:#2a2; color:white; }
    #status { margin-top:20px; font-size:18px; }
  </style>
</head>
<body>
  <h1>Device Lock Control</h1>
  <div>
    <button class="lock" onclick="setLock('true')">Lock</button>
    <button class="unlock" onclick="setLock('false')">Unlock</button>
  </div>
  <div id="status">Loading current state…</div>

<script>
/* --------- CONFIG: replace these three values --------- */
const OWNER = 'YOURUSERNAME';      // your GitHub username or org
const REPO  = 'device-lock';      // repo name
const BRANCH = 'main';            // branch where lock.txt lives
const PATH = 'lock.txt';          // path to the lock file
const TOKEN = 'YOUR_GITHUB_PAT_HERE'; // <--- paste your PAT here (danger: visible to anyone) 
/* ----------------------------------------------------- */

const apiBase = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`;

async function safeBtoa(str) {
  return btoa(unescape(encodeURIComponent(str)));
}

async function getCurrentState() {
  try {
    const rawUrl = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${PATH}?t=${Date.now()}`;
    const r = await fetch(rawUrl);
    if (!r.ok) throw new Error('no file');
    const txt = (await r.text()).trim();
    return txt.toLowerCase();
  } catch (e) {
    return null;
  }
}

async function getFileSha() {
  // GET contents to fetch sha (used for updates)
  const res = await fetch(`${apiBase}?ref=${BRANCH}`, {
    headers: {
      'Accept': 'application/vnd.github+json',
      'Authorization': `token ${TOKEN}`
    }
  });
  if (res.status === 200) {
    const j = await res.json();
    return j.sha;
  } else if (res.status === 404) {
    return null;
  } else {
    throw new Error('GET contents failed: ' + res.status);
  }
}

async function setLock(state) {
  setStatus('Working...')
  try {
    const sha = await getFileSha(); // may be null for new file
    const content = await safeBtoa(state + '\n'); // base64 encode
    const body = {
      message: `Set lock to ${state}`,
      content: content,
      branch: BRANCH
    };
    if (sha) body.sha = sha;

    const putRes = await fetch(apiBase, {
      method: 'PUT',
      headers: {
        'Accept': 'application/vnd.github+json',
        'Authorization': `token ${TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });

    if (!putRes.ok) {
      const txt = await putRes.text();
      throw new Error('Update failed: ' + putRes.status + ' ' + txt);
    }

    setStatus('Updated: ' + state);
  } catch (err) {
    setStatus('Error: ' + err.message);
    alert('Error: ' + err.message);
  }
  // update displayed current state after the action
  setTimeout(refreshState, 700);
}

function setStatus(txt) {
  document.getElementById('status').innerText = txt;
}

async function refreshState() {
  setStatus('Checking…');
  const cur = await getCurrentState();
  if (cur === 'true') setStatus('Current state: LOCKED');
  else if (cur === 'false') setStatus('Current state: UNLOCKED');
  else setStatus('Current state: unknown (file missing)');
}

// init
refreshState();
</script>
</body>
</html>
